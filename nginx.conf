server {
    listen 8080;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;

    # Prevent nginx from appending :8080 to redirects
    absolute_redirect off;
    port_in_redirect off;

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript image/svg+xml;
    gzip_min_length 256;

    # Cache static assets aggressively
    location /_next/static/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location /images/ {
        expires 30d;
        add_header Cache-Control "public";
    }

    # ==========================================================
    # 301 Redirects — Old GymDesk /page/ URLs → New landing pages
    # Preserves Google ranking authority from the old site
    # ==========================================================

    # Discipline pages (SEO-critical)
    location = /page/best-boxing-gym-class {
        return 301 /boxing-port-st-lucie;
    }
    location = /page/best-muay-thai-beginners-class {
        return 301 /muay-thai-port-st-lucie;
    }
    location = /page/kids-martial-arts-program-port-st-lucie {
        return 301 /kids-mma-port-st-lucie;
    }

    # Functional pages → homepage sections
    location = /page/booking {
        return 301 /#free-trial;
    }
    location = /page/location {
        return 301 /#contact;
    }
    location = /page/sponsorships-promotions {
        return 301 /;
    }
    location = /page/affiliates-and-partnerships {
        return 301 /;
    }
    location = /page/privacy-policy {
        return 301 /;
    }

    # Lead magnet pages
    location = /page/strength-training-nutrition-program-free-pdf {
        return 301 /;
    }
    location = /page/thank-you-download-your-strength-training-nutrition-program-free-pdf {
        return 301 /;
    }

    # Confirmation/thank-you pages
    location = /page/thanks-for-reaching-out {
        return 301 /;
    }
    location = /page/your-free-mma-trial-is-locked-in {
        return 301 /;
    }

    # Old GymDesk signup/login redirects
    location = /signup {
        return 301 /#free-trial;
    }
    location = /login {
        return 301 https://v3-mma.gymdesk.com/login;
    }

    # Catch-all for any other old /page/ URLs
    location /page/ {
        return 301 /;
    }

    # SPA fallback — try the file, then folder's index.html, then .html extension, then homepage
    location / {
        try_files $uri $uri/index.html $uri.html /index.html;
    }
}
